---
title: "wk1ex4"
author: "Robert Satzger"
date: "2/20/2023"
output: html_document
---

```{r, include=FALSE}
source("../utilities.R")
```

# Exercise 4. Yield of peas
**a)**
```{r}
library(MASS)

random_plots <- cbind(
  rep(1:24),
  rep(1:6, each = 4),
  replicate(3, c(replicate(6, sample(c(1,1,0,0)))))
)
plots_df <- data.frame(random_plots)
header <- c("plot", "block", "N", "P", "K")
colnames(plots_df) <- header
plots_df[1:8,]

```

**b)**

The following plots show the average yield per block for plots treated with or without Nitrogen (N).

```{r, echo=FALSE}
# library(dplyr)
# library(ggplot2)
# npk %>%
#   group_by(block, N) %>% 
#   summarize(mean_yield = mean(yield),
#             sd_yield = sd(yield)
#             ) %>%
#   ggplot(aes(x=block, y = mean_yield, fill=N)) +
#     geom_col(position=position_dodge())+
#     geom_errorbar(
#       aes(
#         ymin= mean_yield - sd_yield, 
#         ymax = mean_yield + sd_yield
#       ),
#       width=.2,
#       position=position_dodge(.9)
#       )+
#     scale_fill_grey(start = 0.6,
#   end = .8)

par(mfrow=c(1,2))
interaction.plot(npk$block,npk$N,npk$yield)
interaction.plot(npk$N,npk$block,npk$yield)
  
```
The study generally follows an incomplete block design. This would suggest interactions cannot be evaluated. However, taking only the factors block and N into account, there are two observations per condition. This means, the interactions may be evaluated with caution.
The plots suggest that the treatment effect (i.e., the effect of Nitrogen on yield) may differ between blocks. Taking this potential interaction of block and Nitrogen into account can help explain some of the variance in the treatment effect. Therefore, it can help improve the model fit. By performing a full two-way ANOVA, we can test whether the interaction is, in fact, present.

**c)**

[FIXED EFFECTS VS FULL ANOVA?...]
To perform an ANOVA, we first check the normality assumption with the following plots.

```{r}
npk$block <- as.factor(npk$block)
npk$N <- as.factor(npk$N)
shapiro <- check_normality("yield", npk, c("block","N"))
```
The histogram and the QQ-plot indicate a normal distribution. Moreover, the Shapiro-Wilk test returns $p = `r sprintf('%.2f',shapiro[[1]]$p.value)`$. Therefore, we do not find a violation of the normality assumption.
Second, we check for homogeneity of variances.

```{r}
lm_aov1 = lm(yield ~ block * N, data = npk)
check_vars(lm_aov1)
```
[DOES NOT SEEM TO BE MET...
Suggestions in slides:
Otherwise, you may consider
transforming the data (e.g. use log Y );
using a different test;
omit some (outlying) data-points (careful!);
something else (there is no fix that always works).
]

```{r}
aov1 = anova(lm_aov1)
print(aov1)
```

There does not appear to be an interaction effect of block x Nitrogen on yield. Therefore, block does not affect our research question about the effect of Nitrogen on yield. A more sensible way to take block into account in the analysis would be in an additive model.

The Friedman test is not applicable in this case because there are two observations of the outcome variable (yield) per block x Nitrogen combination.

**d)**

[TEST ASSUMPTIONS FOR ONE MODEL?; TESTS DO NOT MAKE MUCH SENSE...]

```{r}
models <- list(
  lm(yield ~ block * N + P + K, npk),
  lm(yield ~ block * P + K + N, npk),
  lm(yield ~ block * K + N + P, npk)
)
aovs <- vector("list", 3)

for (i in 1:length(models)){
  aovs[[i]] <- anova(models[[i]])
  print(aovs[[i]])
}
```
[WHICH MODEL IS BEST?]


**e)**

Below, we base our normality assumption on the checks done in **c**.

```{r}
library(lme4)
mixed_model <- lmer(yield ~ N + (1|block), REML=FALSE, data = npk)
mixed_model1 <- lmer(yield ~ (1|block), REML=FALSE, data = npk)
anova(mixed_model1, mixed_model)
```
[COMPARE TO C]
